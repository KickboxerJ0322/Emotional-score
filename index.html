<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        overflow-x: scroll; /* 横スクロールを許可 */
        font-family: 'Hiragino Kaku Gothic Pro', 'ヒラギノ角ゴ Pro', 'Meiryo', 'sans-serif';
      }
      h1 {
          display: flex;
          align-items: center; /* 縦方向の中央揃え */
          justify-content: flex-start;  /* 左寄せ */
          font-weight: bold;
          color: gray; /* フォントの色をグレーに変更 */
          width: 100%;
          box-sizing: border-box;
          font-size: 40px;
      }
      h1 img {
          width: 100px;
          height: auto;
          margin-right: 10px;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .image-container {
        position: relative;
        display: inline-block;
        margin-top: 20px;
        width: auto; /* 親要素の幅をautoに設定 */
      }
      img {
        max-width: none !important; /* 縮小されないように強制 */
        width: auto;
        height: auto;
      }
      #canvas {
        position: absolute;
        top: 0;
        left: 0;
        max-width: none;
        height: auto;
        z-index: 10;
        pointer-events: none;
      }
      #annotatedImage {
        max-width: none;
        height: auto;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>
      <img src="https://kickboxerj0322.github.io/tohokuzunko/71_emotional score.png" alt="emotional score"> <!-- ロゴ画像の追加 -->
      Emotional score</h1>
    <div class="controls">
      <input type="file" id="fileInput" accept="image/*" />
      <button onclick="analyzeImage()">分析</button>
      <button id="evaluateButton">評価</button>
      <button id="voiceButton1">四国めたん</button> <!-- 音声ボタン追加 -->
      <button id="voiceButton2">ずんだもん</button> <!-- 音声ボタン追加 -->
      <button id="voiceButton3">春日部つむぎ</button> <!-- 音声ボタン追加 -->
      <span id="faceScore" style="margin-left: 20px; font-weight: bold; color: red;"></span>
    </div>

    <!-- ここに評価結果を青色で表示するためのスタイルを追加 -->
    <div id="evaluationResult" style="color: blue;"></div>

    <div class="image-container">
      <img id="uploadedImage" src="" alt="Uploaded Image" />
      <canvas id="canvas"></canvas>
      <img id="annotatedImage" src="" alt="Annotated Image" />
    </div>
    <br><br>
    <div id="analysisResult"></div>

    <script>
      let imageData;
      const gasUrl = 'https://script.google.com/macros/s/AKfycbxMP1sVzgjarVm2z9BXnkTLir8JBtoWXyouEjkk7Rd1X9idal9UmqRWwp6TYTdqwl-iHQ/exec';

      document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.getElementById('uploadedImage');
            img.src = e.target.result;
            img.style.display = 'block';

            img.onload = function() {
              const maxWidth = 1000;  // 最大横幅を1000ピクセルに設定
              let width = img.naturalWidth;
              let height = img.naturalHeight;

              if (width > maxWidth) {
                // 横幅が1000ピクセルを超える場合は縮小する
                const scaleFactor = maxWidth / width;
                width = maxWidth;
                height = height * scaleFactor;
              }

              img.style.width = width + 'px';
              img.style.height = height + 'px';

              const canvas = document.getElementById('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, width, height);

              imageData = canvas.toDataURL('image/png');
            };
          };
          reader.readAsDataURL(file);
        }
      });

      function analyzeImage() {
        fetch(gasUrl, {
          method: 'POST',
          mode: 'cors',  // CORS対応モードでリクエストを送信
          body: JSON.stringify({ image: imageData }),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(result => {
          console.log('Analysis result:', result);
          displayAnalysisResult(result);
        })
        .catch(error => {
          console.error('Fetch error:', error); // エラーをコンソールに表示
        });
      }
           
      function displayAnalysisResult(result) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(document.getElementById('uploadedImage'), 0, 0, canvas.width, canvas.height);

        result.emotions.slice(0, 30).forEach((face, index) => {
          const rect = face.boundingPoly;
          const x = rect.vertices[0].x;
          const y = rect.vertices[0].y;
          const width = rect.vertices[1].x - rect.vertices[0].x;
          const height = rect.vertices[2].y - rect.vertices[0].y;

          ctx.strokeStyle = 'red';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, width, height);
        });

        const annotatedImg = canvas.toDataURL('image/png');
        const annotatedImageElement = document.getElementById('annotatedImage');
        annotatedImageElement.src = annotatedImg;
        annotatedImageElement.style.display = 'block';

        canvas.style.display = 'none';

        const faceScoreElement = document.getElementById('faceScore');
        const japaneseFaceScore = result.faceScoreText
          .replace('Face Score:', 'フェイス・スコア:')
          .replace('Joy:', '喜び:')
          .replace('Sorrow:', '悲しみ:')
          .replace('Anger:', '怒り:')
          .replace('Surprise:', '驚き:');
        
        faceScoreElement.textContent = japaneseFaceScore;

        const resultDiv = document.getElementById('analysisResult');
        resultDiv.innerHTML = `
          <p>Timestamp: ${result.timestamp}</p>
          <p>File Name: ${result.fileName}</p>
          <p>Emotions:<br>${result.emotions.slice(0, 30).map((face, index) => `Person ${index + 1}: Joy - ${face.joyLikelihood}, Sorrow - ${face.sorrowLikelihood}, Anger - ${face.angerLikelihood}, Surprise - ${face.surpriseLikelihood}`).join('<br>')}</p>
          <p>Face Score: ${result.faceScoreText}</p>
          <p>Labels: ${result.labels}</p>
          <p>Landmarks: ${result.landmarks}</p>
          <p>Logos: ${result.logos}</p>
          <p>Texts: ${result.texts}</p>
          <p>Safe Search: ${result.safeSearch}</p>
          <p>Dominant Colors: ${result.dominantColors}</p>
          <p>Web Entities: ${result.webEntities}</p>
        `;
      }

      document.getElementById('evaluateButton').addEventListener('click', function() {
        const analysisText = document.getElementById('analysisResult').innerText;

        fetch('https://visionresult-41433182859.asia-northeast1.run.app', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ analysisText: analysisText })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(data => {
          document.getElementById('evaluationResult').innerText = `評価結果: ${data}`;
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('evaluationResult').innerText = 'エラーが発生しました';
        });
      });

      // 音声再生機能はそのまま
      document.getElementById('voiceButton1').addEventListener('click', function() {
        const evaluationText = document.getElementById('evaluationResult').innerText;
        fetchVoicevoxSpeech(2, evaluationText);
      });

      document.getElementById('voiceButton2').addEventListener('click', function() {
        const evaluationText = document.getElementById('evaluationResult').innerText;
        fetchVoicevoxSpeech(3, evaluationText);
      });

      document.getElementById('voiceButton3').addEventListener('click', function() {
        const evaluationText = document.getElementById('evaluationResult').innerText;
        fetchVoicevoxSpeech(8, evaluationText);
      });

      function fetchVoicevoxSpeech(speaker, text) {
        const encodedText = encodeURIComponent(text);
        const voicevoxAPI = `https://deprecatedapis.tts.quest/v2/voicevox/audio/?key=n877Y12-6633E3M&speaker=${speaker}&pitch=0&intonationScale=1&speed=1.1&text=${encodedText}`;

        const audio = new Audio(voicevoxAPI);
        audio.play();
      }
    </script>
  </body>
</html>
